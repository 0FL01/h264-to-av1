# H264 → H265/HEVC Video Converter (Windows)

Скрипт для автоматического перекодирования H264 (MP4/MKV) в H265/HEVC с аппаратным ускорением, адаптивным битрейтом и безопасной обработкой файлов.

| Скрипт | Платформа | Кодек | Энкодер |
|--------|-----------|-------|---------|
| `convert_windows.py` | Windows | H265/HEVC | NVENC / QSV / AMF / D3D12VA / libx265 |

## Основные возможности
- Автоматический расчёт целевого битрейта с учётом исходника, разрешения и защитных минимумов/максимумов.
- Работа с одиночными файлами и папками: поиск видео, предложение путей сохранения.
- Прогресс-бар и итоговая статистика экономии места.
- Адаптивный GOP: ~10 секунд (`FPS * 10`) и `keyint_min ≈ FPS` для нормальной перемотки без потери эффективности.
- Безопасный выходной контейнер: всегда `mkv` для совместимости с субтитрами и вложениями.
- Пропуск файлов `AV1`/`H265` и опциональное копирование их в выходную папку.
- Атомарные записи и очистка временных файлов при отмене или ошибке.

---

## Особенности Windows-версии
- Поддержка нескольких аппаратных энкодеров:
  - **NVENC** (NVIDIA) — `hevc_nvenc`
  - **AMF** (AMD) — `hevc_amf`
  - **QSV** (Intel QuickSync) — `hevc_qsv`
  - **D3D12VA** — `hevc_d3d12va` (Windows 10+)
  - **Software** — `libx265` (CPU fallback)
- Суффикс выходного файла: `-h265.mkv`
- ANSI-цвета включаются автоматически (Windows 10+)

## Требования
- Python 3.12+
- `ffmpeg` и `ffprobe` с поддержкой выбранного энкодера (`hevc_nvenc`, `hevc_qsv`, `hevc_amf`, `hevc_d3d12va` или `libx265`)

### Установка ffmpeg на Windows
1. Скачайте сборку ffmpeg:
   - https://www.gyan.dev/ffmpeg/builds/ (рекомендуется `ffmpeg-release-full`)
   - https://github.com/BtbN/FFmpeg-Builds/releases
2. Распакуйте архив в удобное место, например `C:\ffmpeg`
3. Добавьте путь `C:\ffmpeg\bin` в переменную окружения `PATH`:
   - Win+R → `sysdm.cpl` → Дополнительно → Переменные среды → `Path`
4. Проверьте установку:
   ```cmd
   ffmpeg -version
   ffmpeg -encoders | findstr hevc
   ```
5. Тест энкодера (пример для AMD AMF):
   ```cmd
   ffmpeg -f lavfi -i color=c=black:s=64x64:d=0.1:r=30 -c:v hevc_amf -f null -
   ```
   Если команда завершается без ошибок — энкодер доступен.

### Запуск
```cmd
python convert_windows.py
```
При первом запуске скрипт автоматически определит доступные энкодеры и предложит выбрать один.

---

## Как работает подбор битрейта (H265)
1. `ffprobe` читает codec/bitrate/FPS/разрешение/длительность. Если битрейт не найден, он оценивается по размеру файла.
2. Степенная кривая `target = 5.5 * bitrate^0.78` с порогами:
   - 4K: 10 000–35 000 kbps
   - 1440p: 6 000–20 000 kbps
   - 1080p: 3 000–12 000 kbps
   - 720p: 1 500–7 000 kbps
   - SD и ниже: 800–4 000 kbps
3. `maxrate = target × 1.5`, `bufsize = target × 2`

### Почему не BPP, а степенная кривая
Степенная функция по фактическому битрейту лучше отражает сложность контента и уменьшает итоговый размер без ручных подстроек: агрессивнее урезает «жирные» исходники и аккуратнее работает с уже сжатыми/чистыми.

---

## Поведение при пакетной обработке
- Перед стартом показывается список найденных файлов.
- После завершения выводится агрегированная статистика (успехи/ошибки/пропуски, общий выигрыш по размеру).
- Пропущенные `AV1/H265` файлы можно скопировать в выходную папку для полного сета.

## Безопасность и отмена
- Прерывания (Ctrl+C) отлавливаются: текущий `ffmpeg` завершается, временный файл удаляется, исходник не затрагивается.
- Запись идёт во временный файл с последующим атомарным переносом.

## Мини-FAQ (Windows)
- **Не найден энкодер?** Проверьте, что ffmpeg в PATH и поддерживает нужный энкодер (`ffmpeg -encoders | findstr hevc`).
- **NVENC не работает?** Обновите драйверы NVIDIA; нужна карта с HEVC (GTX 900+, RTX).
- **QSV не работает?** Установите Intel Media Driver; требуется CPU с QuickSync (Intel Core 6th gen+).
- **AMF не работает?** Обновите драйверы AMD; нужна RX 400+ или APU Ryzen.
- **D3D12VA не работает?** Требуется Windows 10+ и GPU с поддержкой DirectX 12; обновите драйверы.
- **Энкодер «недоступен»?** Скрипт тестирует энкодер реальным кодированием; если драйвер/железо не поддерживает, он будет пропущен.
- **Медленная конвертация?** Выберите аппаратный энкодер вместо libx265 или снизьте пресет libx265.

