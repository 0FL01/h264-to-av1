# H264 → AV1 Converter (VAAPI)

Скрипт `convert.py` автоматизирует перекодирование H264 (MP4/MKV) в AV1 с аппаратным ускорением VAAPI. Он подбирает битрейт под исходник, сохраняет баланс качества и размера, работает интерактивно и безопасно (атомарные записи, очистка временных файлов).

## Возможности
- Аппаратное кодирование AV1 через `av1_vaapi`, декодирование на CPU.
- Автоматический расчёт целевого битрейта: учёт исходного битрейта, разрешения и защитные минимумы/максимумы.
- Работа с одиночными файлами и папками: поиск видео, предложение путей сохранения (`-av1`).
- Прогресс-бар во время конвертации, итоговая статистика экономии места.
- Пропуск файлов `AV1`/`H265` и опциональное копирование их в выходную папку.
- Сохранение субтитров, метаданных и глав: `-map 0`, `-map_metadata 0`, `-map_chapters 0`, копирование аудио/субтитров без рекодирования.
- Атомарность: запись во временный файл и перенос после успеха; корректная очистка при отмене (SIGINT/SIGTERM).

## Требования
- Python 3.12+
- `ffmpeg` и `ffprobe` с поддержкой VAAPI и кодека `av1_vaapi`.
- Драйвер VAAPI для вашего GPU (`intel-media-va-driver` или `libva-mesa-driver`).
- Доступ к устройству `/dev/dri/renderD128` (VAAPI render node).

### Важно про железо
Скрипт сознательно заточен под конкретную конфигурацию VAAPI-ускорителя и проверенные параметры:
- Жёстко задано устройство `va:/dev/dri/renderD128` и фильтр `cas=strength=0.4,format=nv12,hwupload`.
- VBR-настройки и GOP: `-rc_mode VBR`, `-g 240`, `-bf 7`, `-async_depth 4`.
- Эвристика битрейта: сохраняет ~60% исходного H264-битрейта с порогами по разрешениям (минимумы/верхние пределы).
Если у вас другое GPU/драйвер или путь render node, адаптируйте параметры в `convert.py` под свою систему.

## Установка ffmpeg c VAAPI (пример для Fedora)
```bash
sudo dnf install ffmpeg ffmpeg-libs libva libva-utils
vainfo
ffmpeg -encoders | grep vaapi
```

## Запуск
```bash
python3 convert.py
```
Далее скрипт спросит путь к файлу или папке, предложит место сохранения (по умолчанию рядом, с суффиксом `-av1`), подтвердит старт и покажет прогресс. Для уже существующих выходных файлов спросит, перезаписывать ли.

## Сохранение субтитров и метаданных
- В команде `ffmpeg` используется маппинг всех потоков `-map 0`, плюс `-map_metadata 0` и `-map_chapters 0`, чтобы не терять теги и главы.
- Аудио/субтитры копируются (`-c:a copy`, `-c:s copy`) без перекодирования. Встроенные вложения/шрифты (`-c:t copy`) также копируются.
- Если контейнер `mp4` не поддерживает какой-либо поток (например, вложенные шрифты или отдельные типы субтитров), `ffmpeg` может завершиться с ошибкой. В таком случае перезапустите с выходом в `mkv` (поменяйте расширение в `generate_output_path`) или удалите неподдерживаемые вложения.

## Как работает подбор битрейта
1. `ffprobe` читает codec/bitrate/FPS/разрешение/длительность. Если битрейт не найден, вычисляется из размера и длительности.
2. Целевой битрейт = исходный × 0.60, затем ограничивается порогами:
   - 4K: 8 000–25 000 kbps
   - 1440p: 4 000–15 000 kbps
   - 1080p: 2 000–8 000 kbps
   - 720p: 1 000–5 000 kbps
   - SD и ниже: 500–3 000 kbps
3. `maxrate = target × 1.6`, `bufsize = target × 2`.

## Поведение при пакетной обработке
- Список найденных файлов выводится перед стартом.
- После завершения показывается агрегированная статистика (успехи/ошибки/пропуски, общий выигрыш по размеру).
- При наличии пропущенных `AV1/H265` файлов можно скопировать их в выходную папку, чтобы собрать полный сет.

## Безопасность и отмена
- Прерывания (Ctrl+C, SIGTERM) отлавливаются: текущий `ffmpeg` завершается, временный файл удаляется, исходник не трогается.
- Используется временный файл с последующим атомарным `move`, чтобы не оставить частично записанных результатов.

## Мини-FAQ
- **Ничего не происходит?** Проверьте доступ к `/dev/dri/renderD128` и наличие `av1_vaapi` в `ffmpeg -encoders`.
- **Другое GPU/путь устройства?** Отредактируйте параметры `-init_hw_device`, `-filter_hw_device` и фильтр `-vf` в `convert.py`.
- **Хотите ручной контроль битрейта?** Меняйте коэффициент `efficiency_factor` и пороги в функции `calculate_av1_bitrate`.
