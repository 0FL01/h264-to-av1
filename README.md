# H264 → AV1 Video Converter (Docker + Vulkan)

Скрипт для автоматического перекодирования H264 (MP4/MKV) в AV1 с аппаратным ускорением Vulkan через Docker-контейнер.

| Скрипт | Платформа | Runtime | Кодек | Энкодер |
|--------|-----------|---------|-------|---------|
| `convert_linux.py` | Linux | Docker | AV1 | Vulkan (av1_vulkan) |

> **Тестировано на**: RX 780M + 7840HS, Mesa 25.2.7, Kernel 6.17.9, RADV

## Ключевые особенности

- **Docker runtime** — ffmpeg на хосте не требуется
- **Vulkan decode + encode** — полный аппаратный pipeline
- Автоматический расчёт целевого битрейта (степенная кривая)
- Smart Skip: пропуск, если выигрыш по битрейту < ~5%
- Прогресс-бар, ETA, пакетная обработка папок
- Атомарные записи, корректная очистка при Ctrl+C

---

## Требования

- **Docker** (с запущенным daemon)
- Доступ к `/dev/dri` (Vulkan render nodes)
- Vulkan драйвер:
  - **AMD**: RADV (Mesa) с переменной `RADV_PERFTEST=video_decode`
  - **Intel**: ANV с переменной `ANV_VIDEO_DECODE=1`
- Python 3.12+

> [!TIP]
> ffmpeg и ffprobe на хосте **не требуются** — всё работает через контейнер `linuxserver/ffmpeg:8.0.1`

### Проверка Vulkan

```bash
# Убедитесь что устройства доступны
ls -la /dev/dri/

# Проверка Vulkan (если установлен vulkaninfo)
vulkaninfo --summary
```

---

## Запуск

```bash
python3 convert_linux.py
```

При первом запуске скрипт автоматически скачает Docker-образ `linuxserver/ffmpeg:8.0.1` (~150 MB).

Скрипт спросит путь к файлу или папке, предложит место сохранения (по умолчанию рядом, с суффиксом `-av1.mkv`), подтвердит старт и покажет прогресс.

---

## Как это работает

### Архитектура

```
┌─────────────────┐     ┌─────────────────────────────────┐
│ convert_linux.py│────▶│ Docker: linuxserver/ffmpeg:8.0.1│
│   (Python)      │     │   ├─ ffprobe (info)             │
└────────┬────────┘     │   └─ ffmpeg (encode)            │
         │              └────────────────┬────────────────┘
         │                               │
    ┌────▼────┐                    ┌─────▼─────┐
    │ Видео   │◀───────────────────│  Vulkan   │
    │ файлы   │                    │ /dev/dri  │
    └─────────┘                    └───────────┘
                                    (RADV/ANV)
```

### Расчёт битрейта

1. `ffprobe` читает codec/bitrate/FPS/разрешение/длительность
2. Целевой битрейт: `target = 6 × bitrate^0.72` (степенная кривая)
3. Ограничения по разрешению:
   - 4K: 8 000–25 000 kbps
   - 1440p: 4 000–15 000 kbps
   - 1080p: 2 000–8 000 kbps
   - 720p: 1 000–5 000 kbps
   - SD: 500–3 000 kbps
4. Целевой битрейт не выше исходного (`min(target, source_bitrate)`)
5. `maxrate = target × 1.6`, `bufsize = target × 2`
6. Если `target >= source_bitrate × 0.95`, конвертация пропускается как нецелесообразная

---

## Сохранение потоков

- `-map 0` — все потоки (видео, аудио, субтитры)
- `-c:a copy` — аудио без перекодирования
- `-c:s copy` — субтитры копируются как есть
- `-map_metadata 0 -map_chapters 0` — теги и главы сохраняются
- Контейнер по умолчанию: **MKV** (для совместимости с вложениями/шрифтами)

---

## Безопасность и отмена

- Прерывания (Ctrl+C, SIGTERM) отлавливаются
- Docker-контейнер корректно завершается
- Временный файл удаляется, исходник не трогается
- Атомарный `move` после успешного завершения

---

## FAQ

### Docker не запускается?
```bash
sudo systemctl start docker
# или добавьте себя в группу docker:
sudo usermod -aG docker $USER
```

### Нет доступа к /dev/dri/renderD128?
```bash
# Добавьте себя в группы render/video:
sudo usermod -aG render,video $USER
# Перелогиньтесь
```

### Хотите ручной контроль битрейта?
Меняйте коэффициенты `alpha`, `scale` и пороги в функции `calculate_av1_bitrate()`.

### Как использовать другой Docker-образ?
Измените константу `DOCKER_IMAGE` в начале скрипта.
